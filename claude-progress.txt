# Rica - Claude Code Progress Log

## Project Overview

**Name**: rica (Reports for ICA)
**Version**: 1.1.2
**Purpose**: React-based interactive visualization tool for multi-echo fMRI ICA component analysis from tedana/ME-ICA outputs.

### Main Libraries (v2.0.0)
- React 18.2.0 (functional components with hooks)
- visx (D3 + React visualization library for scatter plots, pie charts)
- Tailwind CSS 3.4.0 (styling)
- papaparse 5.4.1 (CSV/TSV parsing)
- react-hotkeys-hook 4.4.4 (keyboard shortcuts)
- Custom tab implementation (replaced @reach/tabs)

### Component Structure (v2.0.0)
```
src/
  index.js              - Main App component (functional, hooks, lazy loading)
  Mobile.js             - Mobile fallback view (<1024px)
  TabFunctions.js       - Animated tab components
  TabComponents.js      - Custom tabs context and components
  LoadingSpinner.js     - Reusable loading spinner
  Carpets/
    Carpets.js          - Carpet plot display with dropdown selector
  Info/
    Info.js             - Report info display tab
  Plots/
    Plots.js            - ICA visualization (visx scatter plots, pie chart)
    ScatterPlot.js      - visx scatter plot with zoom/pan/tooltips
    PieChart.js         - visx donut chart with hover effects
    PlotUtils.js        - Data parsing and color management utilities
    ToggleSwitch.js     - Classification toggle (accepted/rejected)
    ResetAndSave.js     - Reset/Save action buttons
  PopUps/
    IntroPopUp.js       - File upload dialog with Promise-based loading
    AboutPopUp.js       - About modal with version info
  styles/
    tailwind.css        - Tailwind directives
    output.css          - Compiled Tailwind output
```

### Build System
- Create React App (react-scripts 5.0.0)
- PostCSS with Tailwind CSS JIT compilation
- Gulp 3.9.1 for post-build asset inlining (single-file HTML distribution)

### Data Formats Expected
- `*_metrics.tsv`: Component metrics table (not PCA metrics)
- `comp_*.png`: Individual component figure images
- `*.svg`: Carpet plot visualizations
- `report.txt`: Tedana text report
- `tedana_20*.tsv`: Metadata with folder path

---

## Session 0 - Initializer (2025-12-14)

### Files Inspected
1. **package.json** - Dependencies, scripts, version info
2. **src/index.js** - Main App component with state management
3. **src/Plots/Plots.js** - Core ICA visualization logic (~480 lines)
4. **src/Plots/PlotUtils.js** - Data parsing functions
5. **src/Plots/PlotOptions.js** - Chart.js configuration
6. **src/Carpets/Carpets.js** - Carpet plot display
7. **src/PopUps/IntroPopUp.js** - File loading and data parsing
8. **src/Info/Info.js** - Report display
9. **src/Mobile.js** - Mobile fallback
10. **src/TabFunctions.js** - Animated tabs
11. **tailwind.config.js** - Tailwind configuration
12. **postcss.config.js** - PostCSS configuration
13. **gulpfile.js** - Build post-processing
14. **.gitignore** - Git ignore patterns

### Important Findings

#### Code Quality Issues
1. **Console.log statements in production code**: Multiple `console.log` calls remain in `index.js` and `IntroPopUp.js` (data loading debugging)
2. **Deprecated lifecycle methods**: `componentWillMount` used in `index.js` (should be `componentDidMount`)
3. **Typo in variable names**: `rejedtecColor` instead of `rejectedColor` in PlotUtils.js and Plots.js
4. **JSX attribute errors**: `class` used instead of `className` in PopUp SVG icons
5. **Missing key props**: `<span>` elements in ToggleSwitch.js missing key props in map()

#### Dependency Issues
1. **Gulp 3.9.1 is severely outdated**: Current version is 4.x, v3 has known vulnerabilities
2. **Tailwind config uses deprecated `purge` key**: Should be `content` in Tailwind 3.x
3. **No Node.js version specified**: Missing `.nvmrc` or `engines` field
4. **Some peer dependency warnings likely**: React 17 vs newer library versions

#### Missing Infrastructure
1. **No test files**: No `__tests__/` directory, no `*.test.js` files
2. **No dedicated lint/format scripts**: Only eslint from react-app config
3. **No CI/CD configuration**: No GitHub Actions, CircleCI, etc.
4. **No environment variable documentation**: `.env.example` missing

#### Architecture Observations
1. **All class components**: Could benefit from React Hooks refactor for cleaner state management
2. **Nested setTimeout chains**: Data loading in index.js uses nested timeouts (fragile)
3. **No loading states**: User doesn't see progress during 5-second data load delay
4. **No error boundaries**: File loading errors could crash the app

### Files Created
1. **features.json** - 22 features covering all visualization workflows
2. **claude-progress.txt** - This progress tracking file
3. **scripts/init_env.sh** - Environment setup script
4. **scripts/dev.sh** - Development server script
5. **scripts/build.sh** - Production build script
6. **scripts/test.sh** - Test runner script
7. **scripts/lint.sh** - Linting script
8. **.nvmrc** - Node.js version specification (v18)

### Files Modified
1. **package.json** - Added `engines` field, `lint`, `lint:fix`, and `build:inline` scripts
2. **.gitignore** - Added IDE directories, .env, and OS files

### Known Limitations and TODOs

#### High Priority
- [ ] Add unit tests for PlotUtils.js (data parsing functions)
- [ ] Add integration tests for file loading workflow
- [x] Fix deprecated `componentWillMount` usage *(Completed in v2.0.0 - converted to useEffect)*
- [x] Remove console.log statements or add proper logging *(Completed in v2.0.0)*
- [x] Update Gulp to v4 or replace with modern bundler post-processing *(Completed in v2.0.0)*

#### Medium Priority
- [x] Add loading indicator during data parsing *(Completed in v2.0.0 - progress bar added)*
- [ ] Add error handling for malformed input files
- [x] Fix JSX attribute errors (`class` -> `className`) *(Completed in v2.0.0)*
- [x] Add .nvmrc file for Node.js version management *(Already exists)*
- [x] Update Tailwind config from `purge` to `content` *(Completed in v2.0.0)*
- [ ] Add Prettier for code formatting consistency

#### Low Priority
- [x] Consider migrating class components to functional components with hooks *(Completed in v2.0.0 - all components converted)*
- [ ] Add TypeScript support for better maintainability
- [ ] Improve mobile experience (currently just shows redirect message)
- [ ] Add component-level documentation/JSDoc comments
- [ ] Add Storybook for component development

### Open Questions for Future Sessions
1. ~~Is Recharts intentionally included but unused, or should it be removed?~~ **RESOLVED: Removed in v2.0.0**
2. What's the expected behavior when loading folders with missing files?
3. ~~Should the "5 second delay" in data loading be replaced with actual async completion detection?~~ **RESOLVED: Replaced with Promise-based loading in v2.0.0**
4. Are there plans to support additional ICA tools beyond tedana?

---

## Session 1 - Major Modernization (2025-12-14)

### Goals
- Modernize the app for better performance and snappier UI
- Upgrade to React 18 with functional components
- Remove 5-second data loading delay
- Add loading progress indicator
- Enable smooth chart animations
- Fix dependency bloat

### Changes Made

#### Package Updates (package.json)
- **React**: 17.0.2 → 18.2.0
- **Chart.js**: 3.5.0 → 4.4.1
- **react-chartjs-2**: 3.0.4 → 5.2.0
- **Tailwind CSS**: 2.2.19 → 3.4.0
- **Gulp**: 3.9.1 → 4.0.2
- **Removed**: @blueprintjs/core, recharts, react-icons, @reach/tabs, styled-components, react-papaparse, react-hotkeys
- **Added**: papaparse, react-helmet-async, react-hotkeys-hook

#### Component Rewrites (Class → Functional)
1. **src/index.js** - Main App component with hooks, lazy loading, createRoot API
2. **src/Plots/Plots.js** - Memoized chart data, useHotkeys, ref-based click handlers
3. **src/PopUps/IntroPopUp.js** - Promise-based file reading, progress bar
4. **src/Carpets/Carpets.js** - Functional component
5. **src/Info/Info.js** - Functional component
6. **src/Plots/ToggleSwitch.js** - Functional component (removed styled-components)
7. **src/Plots/ResetAndSave.js** - Functional component
8. **src/PopUps/AboutPopUp.js** - Functional component
9. **src/Mobile.js** - Functional component

#### New Files Created
- **src/LoadingSpinner.js** - Reusable loading spinner component
- **src/TabComponents.js** - Custom tabs context and components
- **src/TabFunctions.js** - Animated tabs (replaced @reach/tabs)

#### Files Removed
- **src/Plots/ToggleStyles.js** - Replaced with inline Tailwind
- **src/Carpets/CarpetOption.js** - Simplified into Carpets.js

#### Configuration Updates
- **tailwind.config.js** - Updated for Tailwind v3 (purge → content)
- **gulpfile.js** - Updated for Gulp v4 syntax
- **PlotOptions.js** - Added smooth animations (400ms duration)

### Performance Improvements
1. **Data Loading**: Removed 5-second setTimeout, now uses Promise.all for parallel file reading
2. **Loading Feedback**: Progress bar shows file processing status
3. **Lazy Loading**: Info, Plots, Carpets tabs load on-demand with React.lazy
4. **Chart Animations**: Smooth 400ms initial animation, fast 100ms updates
5. **Memoization**: Chart options memoized to prevent unnecessary re-renders

### Bug Fixes (Session 1.1)
- Fixed navigation bar layout (Carpets tab was hidden behind New/About buttons)
- Fixed tab spacing (tabs were too spread apart with justify-around)
- Fixed chart click interactions (updated for react-chartjs-2 v5 API with refs and getElementAtEvent)

### Features Updated
- load_tedana_folder: Loading now instant with progress indicator
- select_component_scatter: Click interactions restored with v5 API
- select_component_pie: Click interactions restored with v5 API
- animated_tab_navigation: Custom implementation replaces @reach/tabs

### Issues Encountered
- Node.js v24 incompatible with fsevents/chokidar (resolved by using Node 18)
- react-chartjs-2 v5 removed direct onClick prop (resolved with refs + getElementAtEvent)
- @reach/tabs deprecated (resolved with custom TabComponents implementation)

### Next Steps
- Test all features from features.json
- Mark features as passing after verification
- Consider adding error boundaries for robustness

---

## Session 2 - visx Migration (2025-12-14)

### Goals
- Replace Chart.js with visx (Airbnb's D3 + React library) for prettier graphs
- Improve chart interactivity and visual aesthetics
- Add zoom/pan functionality to scatter plots

### Changes Made

#### Package Updates (package.json)
- **Removed**: chart.js, react-chartjs-2, chartjs-plugin-zoom
- **Added**: @visx/axis, @visx/event, @visx/grid, @visx/group, @visx/responsive, @visx/scale, @visx/shape, @visx/tooltip, @visx/zoom, d3-shape

#### New Components Created
1. **src/Plots/ScatterPlot.js** - visx-based scatter plot with:
   - Zoom/pan functionality (scroll to zoom, drag to pan, double-click to zoom in)
   - Tooltips showing component details on hover
   - Color-coded points by classification
   - Selected point highlighting with border
   - Grid lines and axis labels

2. **src/Plots/PieChart.js** - visx-based donut chart with:
   - Hover effects with scale transform
   - Tooltips showing variance percentage
   - Click handling for slice selection
   - Center text label

#### Files Modified
1. **src/Plots/Plots.js** - Rewrote to use visx components with fixed dimensions

#### Files Removed
1. **src/Plots/PlotOptions.js** - No longer needed (was Chart.js configuration)

### Technical Details
- Using fixed chart dimensions (340x300) instead of ParentSize for reliability
- All hooks called before conditional returns to comply with React rules
- Guard clauses added for invalid dimensions
- Smooth transitions on hover/select (0.15s ease-out)

### Issues Encountered
- @visx/grid package was missing initially (resolved by adding to dependencies)
- ParentSize component returning 0 dimensions (resolved by using fixed dimensions)
- React hooks rules violation when using early returns (resolved by moving guards after hooks)

### Session 2.1 - Layout and UX Updates
- Changed layout: 4 interactive plots on LEFT in 2x2 grid, brain image on RIGHT
- Changed chart backgrounds from gray (#fafafa) to white (#ffffff)
- Fixed tooltip z-index issue using `useTooltipInPortal` to render tooltips in a portal
- Made tooltips smaller and more compact
- Fixed pie chart sorting: groups by classification (accepted, rejected, ignored) then by variance descending within each group

### Next Steps
- Verify all chart interactions work correctly
- Test keyboard shortcuts (A/R/I for classification, arrow keys for navigation)
- Update features.json with passing tests

---

## Session 2.2 - UX Polish and Cleanup (2025-12-14)

### Goals
- Improve chart interaction UX
- Fix layout issues with controls
- Remove deprecated "ignored" classification
- Polish visual details

### Changes Made

#### Chart Interactions
1. **Arrow key navigation now follows pie chart order** - Components are navigated in the same order as they appear in the pie chart (grouped by classification, sorted by variance)
2. **Selected elements render on top** - In both scatter plots and pie chart, the selected element is rendered last so it's always fully visible
3. **Invisible hit areas for small pie slices** - Added 20px transparent stroke around pie slices for easier clicking on small segments

#### Layout Updates
1. **50/50 layout** - Interactive plots grid now takes 50% width, brain image takes 50% width
2. **Chart dimensions increased** - Charts now 420x380 pixels for better visibility in 2x2 grid
3. **Fixed Reset/Save button layout** - Buttons now appear inline to the right of the toggle switch (removed absolute positioning)

#### Classification Changes
1. **Removed "ignored" classification** - tedana no longer generates ignored components
   - Removed from ToggleSwitch values
   - Removed "I" keyboard shortcut
   - Updated help text from "A/R/I" to "A/R"

#### Style Fixes
1. **Icon spacing** - Reset/Save icons now have proper spacing from text (inline style marginRight: 8px)
2. **Toggle switch vertical centering** - Labels now use flexbox with `items-center justify-center` for proper vertical alignment
3. **Cursor pointer** - Toggle switch labels now show pointer cursor on hover (inline style)
4. **Fixed slider position calculation** - Changed from percentage-based to pixel-based (`index * 90px`) for 2 values

### Files Modified
1. **src/Plots/Plots.js** - Arrow key navigation, layout changes, removed "ignored"
2. **src/Plots/ScatterPlot.js** - Selected point renders last (on top)
3. **src/Plots/PieChart.js** - Selected slice renders last, invisible hit areas
4. **src/Plots/ToggleSwitch.js** - Vertical centering, cursor pointer, slider position fix
5. **src/Plots/ResetAndSave.js** - Icon spacing, removed absolute positioning

### Technical Notes
- Tailwind CSS classes like `cursor-pointer` and `mr-*` weren't being applied to FontAwesome icons and some elements; resolved by using inline styles
- SVG rendering order determines visual stacking (elements rendered last appear on top)

---

## Session 3 - Niivue Integration (2025-12-14)

### Goals
- Replace static PNG brain images with interactive Niivue 3D viewer
- Add interactive time series visualization
- Add FFT power spectrum visualization
- Synchronize all visualizations with component selection

### Changes Made

#### New Dependencies (package.json)
- `@niivue/niivue` - WebGL2-based neuroimaging viewer
- `fft.js` - Fast Fourier Transform for power spectrum computation

#### New Utility Files
1. **src/utils/tsvParser.js** - Parse mixing matrix TSV file
   - `parseMixingMatrix()` - Converts TSV to component time series array
   - `getComponentIndex()` - Maps component labels to array indices

2. **src/utils/fftUtils.js** - FFT computation utilities
   - `computePowerSpectrum()` - One-sided power spectrum from time series
   - `powerToDecibels()` - Convert power to dB scale

#### New Visualization Components
1. **src/Plots/TimeSeries.js** - visx line chart for component time series
   - Zoom/pan support with @visx/zoom
   - Hover tooltips showing TR and value
   - Blue line (#3b82f6) color scheme

2. **src/Plots/FFTSpectrum.js** - visx line chart for power spectrum
   - Computes FFT internally using fft.js (memoized)
   - X-axis: Frequency (cycles/TR)
   - Y-axis: Power with exponential notation
   - Green line (#10b981) color scheme

3. **src/Plots/BrainViewer.js** - Niivue wrapper component
   - Loads 4D NIfTI from ArrayBuffer
   - Uses `setFrame4D()` to display selected component
   - Warm colormap for z-scores
   - Multi-planar slice view
   - Loading and error states

#### Data Loading Updates (IntroPopUp.js)
- Added `readFileAsArrayBuffer()` helper
- New file patterns:
  - `*_mixing.tsv` (excluding PCA) - ICA time series
  - `*stat-z_components.nii.gz` (ICA) - 4D brain maps
- Passes `mixingMatrix` and `niftiBuffer` to parent

#### State Management (index.js)
- New state: `mixingMatrix`, `niftiBuffer`
- Passes new props to Plots component

#### Plots.js Integration
- New props: `mixingMatrix`, `niftiBuffer`
- `hasInteractiveViews` - Conditional rendering flag
- `currentTimeSeries` - Memoized time series for selected component
- Graceful fallback to PNG if NIfTI/mixing files not available

### New Layout (Right Side)
```
+---------------------------+
|   Time Series (600x180)   |
+---------------------------+
|   Brain Stat Map          |
|   (Niivue - 600x400)      |
+---------------------------+
|   FFT Spectrum (600x180)  |
+---------------------------+
```

### Files Created
- `src/utils/tsvParser.js`
- `src/utils/fftUtils.js`
- `src/Plots/TimeSeries.js`
- `src/Plots/FFTSpectrum.js`
- `src/Plots/BrainViewer.js`

### Files Modified
- `package.json` - Added @niivue/niivue, fft.js
- `src/PopUps/IntroPopUp.js` - Load mixing TSV + NIfTI
- `src/index.js` - Add state, pass props
- `src/Plots/Plots.js` - Import new components, conditional layout

### Technical Notes
- Niivue requires WebGL2 canvas
- 4D NIfTI loaded as ArrayBuffer from FileReader
- `setFrame4D(volumeId, index)` switches displayed volume
- FFT memoized to prevent expensive recomputation
- Graceful degradation if new files not present

### Test Data
Location: `/Users/eurunuela/tedana_for_rica_tests/`
- 32 ICA components
- ~200 timepoints
- 3MB NIfTI file

---

## Session 3.1 - Niivue Fixes (2025-12-14)

### Issues Addressed
1. **NIfTI loading error** - "Failed to parse NIfTI file components.nii.gz"
2. **Wrong layout order** - Brain map should be in middle, not on top
3. **Width mismatch** - Visualizations should match previous PNG width

### Changes Made

#### BrainViewer.js Fixes
- Changed from `loadVolumes()` with `buffer` property to `loadFromArrayBuffer()`
- Added Uint8Array conversion: `new Uint8Array(niftiBuffer)`
- Made `attachToCanvas()` async (added await)
```javascript
// Before (broken)
const volumeData = { url: "components.nii.gz", buffer: niftiBuffer };
await nv.loadVolumes([volumeData]);

// After (working)
const uint8Array = new Uint8Array(niftiBuffer);
await nv.loadFromArrayBuffer(uint8Array, "components.nii.gz");
```

#### Plots.js Layout Update
- Changed order: Time Series (top) → Brain Map (middle) → FFT (bottom)
- Unified width to 600px for all components
- Adjusted heights: TimeSeries 180px, BrainViewer 400px, FFTSpectrum 180px
- Changed gap from 4 to 2 for tighter stacking

### Files Modified
- `src/Plots/BrainViewer.js` - Fixed Niivue ArrayBuffer loading
- `src/Plots/Plots.js` - Updated layout order and dimensions

---

## Session 3.2 - Niivue Colormap and Display Polish (2025-12-14)

### Goals
- Implement proper RdBu colormap matching matplotlib
- Configure multiplanar view (axial, sagittal, coronal in row)
- Match visualization widths and colors with component classification
- Polish background and colormap display

### Changes Made

#### BrainViewer.js - Colormap Implementation
1. **Custom RdBu colormap** - Created two half-colormaps to match matplotlib's RdBu:
   - `white2red`: For positive values (white at 0 → red at max)
   - `blue2white`: For negative values (blue at -max → white at 0)

2. **Colormap range**: Set to 90% of absolute maximum for symmetric display

3. **Multiplanar configuration**:
   - `setSliceType(nv.sliceTypeMultiplanar)` - Enable multiplanar view
   - `setMultiplanarLayout(3)` - ROW layout (axial, sagittal, coronal side by side)
   - `multiplanarShowRender = 0` - Disable 3D render
   - `multiplanarEqualSize = true` - Equal size panels
   - `multiplanarPadPixels = 0` - No gaps between views

4. **Background**: White background (`backColor: [1, 1, 1, 1]`)

5. **Loading method**: Changed to Blob URL approach for reliable NIfTI loading

#### Plots.js - Visualization Updates
1. **Width**: All visualizations (TimeSeries, BrainViewer, FFTSpectrum) set to 800px
2. **Line colors**: Dynamic based on classification
   - Accepted components: Green (#22C55E)
   - Rejected components: Red (#EF4444)

#### TimeSeries.js & FFTSpectrum.js
- Added `lineColor` prop for dynamic coloring
- Default colors updated to match app theme

#### IntroPopUp.js - Mask Loading
- Added detection and loading of mask files (`*_mask.nii*`)
- Passes `maskBuffer` to parent component for optional underlay

### Technical Details
```javascript
// Custom colormaps for diverging display
const white2red = {
  R: [255, 254, 252, 250, 246, 239, 229, 215, 199, 180, 165, 146, 127, 103, 84, 67],
  G: [255, 240, 220, 199, 175, 150, 125, 99, 75, 55, 40, 28, 18, 8, 2, 0],
  B: [255, 237, 214, 190, 165, 140, 114, 89, 68, 50, 38, 28, 20, 13, 7, 3],
  ...
};

const blue2white = {
  R: [5, 24, 47, 75, 103, 134, 162, 186, 206, 222, 235, 244, 250, 253, 254, 255],
  G: [48, 78, 111, 143, 173, 197, 217, 232, 243, 250, 253, 254, 254, 254, 255, 255],
  B: [97, 127, 157, 183, 206, 224, 238, 247, 252, 254, 254, 254, 254, 254, 255, 255],
  ...
};
```

### Files Modified
- `src/Plots/BrainViewer.js` - Custom RdBu colormap, multiplanar config, Blob URL loading
- `src/Plots/Plots.js` - Width 800px, dynamic line colors
- `src/Plots/TimeSeries.js` - Added lineColor prop
- `src/Plots/FFTSpectrum.js` - Added lineColor prop
- `src/PopUps/IntroPopUp.js` - Mask file loading
- `src/index.js` - maskBuffer state

### Colormap Evolution
1. Started with `blue2red` built-in colormap
2. Tried `jet` colormap (user disliked green background)
3. Added 0.001 threshold to hide near-zero values
4. Implemented custom RdBu matching matplotlib
5. Split into two half-colormaps for proper diverging display
6. Removed threshold as no longer needed with proper colormap

---

## Session 3.3 - Component Table (2025-12-14)

### Goals
- Add interactive component metrics table below the charts
- Synchronize table selection with chart selection
- Display original metrics data from TSV file

### Changes Made

#### New Component: ComponentTable.js
- Displays full metrics data from the original TSV file
- Columns: Component, Kappa, Rho, Variance %, κ Rank, ρ Rank, Dice FT2, Dice FS0, S/N t, Classification, Tags
- Interactive row selection synced with charts
- Auto-scrolls to selected row when component is selected from charts
- Selected row highlighted with classification color (green/red)
- Rounded corners on row highlight and classification badges
- Fixed-width classification badges for consistent appearance
- Sticky header row with scrollable body (max 350px height)

#### ToggleSwitch.js Fix
- Changed selected text color from white to dark gray (#1f2937) for readability

### Features
- Click table row to select component (updates all charts)
- Click chart point/slice to select component (table scrolls to row)
- Classification updates reflect in table in real-time
- Hover effects on rows
- Responsive scrolling for large datasets

### Files Created
- `src/Plots/ComponentTable.js`

### Files Modified
- `src/Plots/Plots.js` - Import and render ComponentTable
- `src/Plots/ToggleSwitch.js` - Fix text color contrast

---

## Session 3.4 - Modern Navbar and UX Polish (2025-12-14)

### Goals
- Modernize the top navbar with Notion-style design
- Add click-outside-to-close functionality for popups
- Add favicon as logo in navbar
- Fix data path extraction for Info tab

### Changes Made

#### Modern Navbar (index.js)
- **Left section**: Favicon logo (28x28px) + "Rica" text + version badge (v2.0)
- **Center section**: Pill-style tab navigation with gray background container
  - Selected tab has white background with subtle shadow
  - Smooth hover effects on unselected tabs
- **Right section**:
  - "New" button with border and plus icon
  - Icon-only "About" button (cleaner look)
- Clean white background with subtle shadow
- Better spacing and typography

#### Tab Styling (TabFunctions.js)
- Removed underline indicator animation
- Changed to pill-style selected state (white background, rounded corners)
- Simplified component by removing unused refs and effects

#### Click-Outside-to-Close (IntroPopUp.js, AboutPopUp.js)
- Added onClick handler on backdrop to close popup
- Inner card uses stopPropagation() to prevent closing when clicking inside
- Same behavior as clicking the X button

#### Path Extraction Fix (IntroPopUp.js)
- Fixed regex to properly extract output directory from tedana log
- Now searches for "Using output directory:" and extracts full path
- Handles paths with colons correctly

### Files Modified
- `src/index.js` - Modern navbar layout with favicon
- `src/TabFunctions.js` - Pill-style tabs, removed underline
- `src/PopUps/IntroPopUp.js` - Click-outside-to-close, path extraction fix
- `src/PopUps/AboutPopUp.js` - Click-outside-to-close

---

## Session 3.5 - UX Polish and Display Improvements (2025-12-14)

### Goals
- Remove focus outline on chart container
- Format component names for display (replace underscores with spaces)
- Improve pie chart hover behavior (reduce flickering)
- Make table header sticky when scrolling

### Changes Made

#### Focus Outline Removal (Plots.js)
- Added `outline: "none"` and `boxShadow: "none"` inline styles
- Added Tailwind classes `focus:outline-none focus:ring-0`
- Prevents blue outline when using keyboard navigation (arrow keys)

#### Component Name Formatting (PlotUtils.js)
- New utility function `formatComponentName()` - converts "ICA_01" to "ICA 01"
- Applied to:
  - ScatterPlot tooltips
  - PieChart tooltips
  - ComponentTable Component column
  - TimeSeries title
  - BrainViewer title
- Original names preserved for saving manual classifications

#### Pie Chart Hover Improvements (PieChart.js)
- Changed from `onMouseEnter` to `onMouseMove` for more reliable detection
- Removed scale effect on hover (only selected slices scale now)
- Hovered slices show gray border instead of scaling (prevents flickering)
- Added `onMouseLeave` to parent Group for proper cleanup

#### Sticky Table Header (ComponentTable.js)
- Applied sticky positioning to each `th` element with inline styles
- Position: sticky, top: 0, backgroundColor: #f3f4f6, zIndex: 10
- Header stays visible when scrolling through component rows

### Files Modified
- `src/Plots/Plots.js` - Focus outline removal, component label formatting
- `src/Plots/PlotUtils.js` - New formatComponentName() function
- `src/Plots/ScatterPlot.js` - Import and use formatComponentName for tooltips
- `src/Plots/PieChart.js` - Import and use formatComponentName, improved hover
- `src/Plots/ComponentTable.js` - Import and use formatComponentName, sticky header

---

## Session 3.6 - Final Polish (2025-12-14)

### Goals
- Fix pie chart selected slice displacement
- Add wrap-around navigation for arrow keys
- Remove focus outline from brain viewer

### Changes Made

#### Pie Chart Selection (PieChart.js)
- Removed scale transform on selected slices (was causing displacement)
- Selected slice now stays in place while appearing on top of neighbors
- Visual selection indicators: thicker dark border (3px) and drop shadow
- Slice rendered last in SVG order to appear on top

#### Arrow Key Wrap-Around (Plots.js)
- Left arrow at first component now wraps to last component
- Right arrow at last component now wraps to first component
- Enables continuous circular navigation through pie chart order

#### Brain Viewer Focus Outline (BrainViewer.js)
- Added `outline: "none"` to canvas element
- Prevents blue focus outline when using keyboard navigation

### Files Modified
- `src/Plots/PieChart.js` - Removed scale transform, kept border/shadow selection
- `src/Plots/Plots.js` - Wrap-around logic for arrow key navigation
- `src/Plots/BrainViewer.js` - Canvas outline removal

---

## Session 4 - Colormap and Saturation Controls (2025-12-15)

### Goals
- Change brain viewer colormap to warm/cool diverging scheme
- Add user-adjustable saturation slider for colormap range
- Fix initialization order to apply colormap correctly on first load

### Changes Made

#### BrainViewer.js - Colormap Updates
1. **Using NiiVue's built-in colormaps**:
   - `warm` colormap for positive values (orange/red tones)
   - `cool` colormap for negative values (cyan/blue tones)

2. **Added saturation prop**:
   - Accepts saturation value (0.01 to 1.0) to control colormap range
   - Range calculated as `maxAbs * saturation`
   - Stored `maxAbsRef` for dynamic saturation adjustments

3. **Fixed initialization order**:
   - Set frame with `setFrame4D` BEFORE setting colormap range
   - Call `updateGLVolume()` and `drawScene()` after setting range
   - Ensures correct colormap/saturation on first load

4. **Reduced spacing between brain views**:
   - `multiplanarPadPixels = -30` for tighter layout

#### Plots.js - Saturation Slider
1. **Added saturation state**: `colormapSaturation` with default 0.1 (10%)
2. **Slider UI**:
   - Range slider from 1% to 100%
   - Positioned between brain viewer and FFT chart
   - Shows current percentage value
   - 400px width, centered with brain viewer

3. **Layout fix**:
   - Right side container changed from 50% to 800px width
   - Matches chart width for proper centering

### Files Modified
- `src/Plots/BrainViewer.js` - Colormap, saturation prop, initialization order
- `src/Plots/Plots.js` - Saturation slider UI, layout width fix

### Technical Notes
- Saturation slider updates colormap range in real-time without reinitializing NiiVue
- White background maintained by setting `opts.backColor` before `drawScene()`

---

## Session 5 - Popup Modernization (2025-12-15)

### Goals
- Modernize IntroPopUp and AboutPopUp with Notion-inspired design
- Fix popup centering issues
- Update styling to match app theme

### Changes Made

#### IntroPopUp.js - Modern Redesign
1. **Notion-inspired styling**:
   - Clean modal with dark overlay (`rgba(0, 0, 0, 0.4)`)
   - Proper centering using fixed positioning with flexbox
   - Subtle shadow and 8px border radius
   - 480px max width

2. **Updated content**:
   - Changed description to reference only tedana (removed aroma)
   - Privacy notice with lock emoji
   - Sky-500 accent color (`#0ea5e9`) for button

3. **Improved close button**:
   - Small 28px square button with hover effect
   - Clean X icon

#### AboutPopUp.js - Modern Redesign
1. **Same Notion-inspired styling**:
   - Consistent with IntroPopUp design
   - 440px max width
   - Dark GitHub button (`#111827`)

2. **Fixed version display**:
   - Hardcoded v2.0.0

#### Plots.js - Slider Focus Fix
- Removed focus outline from saturation slider

### Files Modified
- `src/PopUps/IntroPopUp.js` - Complete redesign with inline styles
- `src/PopUps/AboutPopUp.js` - Complete redesign with inline styles
- `src/Plots/Plots.js` - Slider outline removal
- `src/styles/tailwind.css` - Added fadeInScale keyframes (unused after redesign)

---

## Template for Future Sessions

```
## Session N - [Brief Description] (YYYY-MM-DD)

### Goals
- Goal 1
- Goal 2

### Changes Made
1. **file.js** - Description of changes
2. **file2.js** - Description of changes

### Features Updated
- feature_id: now passes=true (description of test/verification)

### Issues Encountered
- Issue description and resolution

### Next Steps
- Recommended follow-up work
```
